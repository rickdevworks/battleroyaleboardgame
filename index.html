<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Grid Battle - Fixed Aim System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 800px;
            width: 100%;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            background: #16213e;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .player-info {
            text-align: center;
        }
        
        .player-info h3 {
            color: #4cc9f0;
            margin-bottom: 5px;
        }
        
        .health-bar {
            width: 150px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px auto;
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #f72585, #ff4da6);
            transition: width 0.3s;
        }
        
        .game-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            gap: 2px;
            width: 500px;
            height: 500px;
            background: #0f3460;
            padding: 5px;
            border-radius: 5px;
            position: relative;
        }
        
        .grid-cell {
            background: #1e3163;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .grid-cell.highlighted {
            background: #4cc9f0;
            box-shadow: 0 0 10px #4cc9f0;
        }
        
        .grid-cell.aim-highlight {
            background: rgba(245, 37, 133, 0.7);
            box-shadow: 0 0 15px #f72585;
            border: 2px solid #f72585;
        }
        
        .player {
            width: 70%;
            height: 70%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .player1 {
            background: linear-gradient(135deg, #f72585, #ff4da6);
        }
        
        .player2 {
            background: linear-gradient(135deg, #4361ee, #4cc9f0);
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .action-btn {
            padding: 15px;
            background: linear-gradient(135deg, #4361ee, #4cc9f0);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .aim-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            background: rgba(15, 52, 96, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .dpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
            width: 150px;
            height: 150px;
        }
        
        .dpad-btn {
            background: #2d4263;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            transition: background 0.2s;
        }
        
        .dpad-btn:hover:not(:disabled) {
            background: #4361ee;
        }
        
        .dpad-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .center-btn {
            grid-column: 2;
            grid-row: 2;
            background: #1e3163;
        }
        
        .up { grid-column: 2; grid-row: 1; }
        .left { grid-column: 1; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; }
        .down { grid-column: 2; grid-row: 3; }
        
        .shoot-btn {
            padding: 20px 40px;
            background: linear-gradient(135deg, #f72585, #ff4da6);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.2s, opacity 0.2s;
            min-width: 150px;
            text-align: center;
        }
        
        .shoot-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        
        .shoot-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .log {
            width: 100%;
            height: 120px;
            background: #0f3460;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.4;
            margin-top: 10px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .player1-log {
            border-left: 3px solid #f72585;
        }
        
        .player2-log {
            border-left: 3px solid #4361ee;
        }
        
        .system-log {
            border-left: 3px solid #4cc9f0;
            color: #4cc9f0;
        }
        
        .current-weapon {
            margin-top: 5px;
            font-size: 12px;
            color: #4cc9f0;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>RPG Grid Battle</h1>
        
        <div class="game-info">
            <div class="player-info">
                <h3>Player 1</h3>
                <div class="health-bar">
                    <div class="health-fill" id="health1" style="width: 100%;"></div>
                </div>
                <div>HP: <span id="hp1">100</span>/100</div>
                <div class="current-weapon">Weapon: Pistol (Damage: 15-25)</div>
            </div>
            
            <div class="player-info">
                <h3>Player 2</h3>
                <div class="health-bar">
                    <div class="health-fill" id="health2" style="width: 100%;"></div>
                </div>
                <div>HP: <span id="hp2">100</span>/100</div>
                <div class="current-weapon">Weapon: Pistol (Damage: 15-25)</div>
            </div>
        </div>
        
        <div class="game-grid" id="gameGrid"></div>
        
        <div class="controls">
            <div class="action-buttons">
                <button class="action-btn" id="moveBtn">Move</button>
                <button class="action-btn" id="aimBtn">Aim & Shoot</button>
                <button class="action-btn" id="healBtn">Heal</button>
                <button class="action-btn" id="endTurnBtn">End Turn</button>
            </div>
            
            <div class="aim-controls" id="aimControls" style="display: none;">
                <div class="dpad">
                    <button class="dpad-btn up" id="aimUp">↑</button>
                    <button class="dpad-btn left" id="aimLeft">←</button>
                    <div class="dpad-btn center-btn"></div>
                    <button class="dpad-btn right" id="aimRight">→</button>
                    <button class="dpad-btn down" id="aimDown">↓</button>
                </div>
                <button class="shoot-btn" id="shootBtn">SHOOT</button>
            </div>
            
            <div class="log" id="gameLog">
                <div class="log-entry system-log">Game Started! Player 1's turn.</div>
            </div>
        </div>
    </div>

    <script>
        class Game {
            constructor() {
                this.gridSize = 10;
                this.currentPlayer = 1;
                this.players = {
                    1: { hp: 100, maxHp: 100, x: 0, y: 0, weapon: { name: 'Pistol', minDamage: 15, maxDamage: 25, range: 4 } },
                    2: { hp: 100, maxHp: 100, x: 9, y: 9, weapon: { name: 'Pistol', minDamage: 15, maxDamage: 25, range: 4 } }
                };
                
                this.isAiming = false;
                this.aimPos = { x: 0, y: 0 };
                this.selectedAction = null;
                this.moveRange = 3;
                this.remainingMoves = 3;
                
                this.initGrid();
                this.setupEventListeners();
                this.updateDisplay();
                this.updateGrid();
            }
            
            initGrid() {
                const grid = document.getElementById('gameGrid');
                grid.innerHTML = '';
                
                for (let y = 0; y < this.gridSize; y++) {
                    for (let x = 0; x < this.gridSize; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.dataset.x = x;
                        cell.dataset.y = y;
                        
                        const player1 = this.players[1];
                        const player2 = this.players[2];
                        
                        if (player1.x === x && player1.y === y) {
                            const playerDiv = document.createElement('div');
                            playerDiv.className = 'player player1';
                            playerDiv.textContent = 'P1';
                            cell.appendChild(playerDiv);
                        } else if (player2.x === x && player2.y === y) {
                            const playerDiv = document.createElement('div');
                            playerDiv.className = 'player player2';
                            playerDiv.textContent = 'P2';
                            cell.appendChild(playerDiv);
                        }
                        
                        grid.appendChild(cell);
                    }
                }
            }
            
            setupEventListeners() {
                document.getElementById('moveBtn').addEventListener('click', () => this.startMove());
                document.getElementById('aimBtn').addEventListener('click', () => this.startAim());
                document.getElementById('healBtn').addEventListener('click', () => this.heal());
                document.getElementById('endTurnBtn').addEventListener('click', () => this.endTurn());
                
                // D-pad controls for aiming
                document.getElementById('aimUp').addEventListener('click', () => this.moveAim(0, -1));
                document.getElementById('aimDown').addEventListener('click', () => this.moveAim(0, 1));
                document.getElementById('aimLeft').addEventListener('click', () => this.moveAim(-1, 0));
                document.getElementById('aimRight').addEventListener('click', () => this.moveAim(1, 0));
                document.getElementById('shootBtn').addEventListener('click', () => this.shoot());
                
                // Grid cell click for movement
                document.getElementById('gameGrid').addEventListener('click', (e) => {
                    const cell = e.target.closest('.grid-cell');
                    if (cell && this.selectedAction === 'move') {
                        const x = parseInt(cell.dataset.x);
                        const y = parseInt(cell.dataset.y);
                        this.movePlayer(x, y);
                    }
                });
            }
            
            startMove() {
                if (this.selectedAction === 'move') {
                    this.cancelAction();
                    return;
                }
                
                this.cancelAction();
                this.selectedAction = 'move';
                this.remainingMoves = this.moveRange;
                this.highlightMoveRange();
                this.addLog(`Player ${this.currentPlayer} selected Move (${this.remainingMoves} moves remaining)`);
            }
            
            highlightMoveRange() {
                const player = this.players[this.currentPlayer];
                this.clearHighlights();
                
                for (let y = 0; y < this.gridSize; y++) {
                    for (let x = 0; x < this.gridSize; x++) {
                        const distance = Math.abs(x - player.x) + Math.abs(y - player.y);
                        if (distance <= this.moveRange && !this.isOccupied(x, y)) {
                            const cell = this.getCell(x, y);
                            cell.classList.add('highlighted');
                        }
                    }
                }
            }
            
            startAim() {
                if (this.isAiming) {
                    this.cancelAction();
                    return;
                }
                
                this.cancelAction();
                this.isAiming = true;
                this.selectedAction = 'aim';
                
                const player = this.players[this.currentPlayer];
                this.aimPos = { x: player.x, y: player.y };
                
                // Show aim controls
                document.getElementById('aimControls').style.display = 'flex';
                
                this.updateAimHighlight();
                this.addLog(`Player ${this.currentPlayer} entering Aim Mode`);
            }
            
            moveAim(dx, dy) {
                if (!this.isAiming) return;
                
                const player = this.players[this.currentPlayer];
                const weaponRange = player.weapon.range;
                
                const newX = this.aimPos.x + dx;
                const newY = this.aimPos.y + dy;
                
                // Calculate distance from player
                const distance = Math.abs(newX - player.x) + Math.abs(newY - player.y);
                
                // Check bounds and range
                if (newX >= 0 && newX < this.gridSize && 
                    newY >= 0 && newY < this.gridSize &&
                    distance <= weaponRange) {
                    
                    this.aimPos.x = newX;
                    this.aimPos.y = newY;
                    this.updateAimHighlight();
                }
            }
            
            updateAimHighlight() {
                this.clearHighlights();
                
                // Highlight aim position
                const aimCell = this.getCell(this.aimPos.x, this.aimPos.y);
                if (aimCell) {
                    aimCell.classList.add('aim-highlight');
                }
                
                // Also show player's range
                const player = this.players[this.currentPlayer];
                const weaponRange = player.weapon.range;
                
                for (let y = 0; y < this.gridSize; y++) {
                    for (let x = 0; x < this.gridSize; x++) {
                        const distance = Math.abs(x - player.x) + Math.abs(y - player.y);
                        if (distance <= weaponRange) {
                            const cell = this.getCell(x, y);
                            cell.classList.add('highlighted');
                        }
                    }
                }
            }
            
            shoot() {
                if (!this.isAiming) return;
                
                const shooter = this.players[this.currentPlayer];
                const targetPlayer = this.players[this.currentPlayer === 1 ? 2 : 1];
                
                // Check if target is at aim position
                if (targetPlayer.x === this.aimPos.x && targetPlayer.y === this.aimPos.y) {
                    // Calculate damage
                    const min = shooter.weapon.minDamage;
                    const max = shooter.weapon.maxDamage;
                    const damage = Math.floor(Math.random() * (max - min + 1)) + min;
                    
                    // Apply damage
                    targetPlayer.hp = Math.max(0, targetPlayer.hp - damage);
                    
                    this.addLog(`Player ${this.currentPlayer} shoots Player ${this.currentPlayer === 1 ? 2 : 1} for ${damage} damage!`, this.currentPlayer);
                    
                    if (targetPlayer.hp <= 0) {
                        this.addLog(`Player ${this.currentPlayer === 1 ? 2 : 1} has been defeated!`, 'system');
                    }
                } else {
                    this.addLog(`Player ${this.currentPlayer} shoots at empty space`, this.currentPlayer);
                }
                
                // End aim mode
                this.cancelAction();
                this.endTurn();
            }
            
            movePlayer(x, y) {
                const player = this.players[this.currentPlayer];
                
                // Calculate distance
                const distance = Math.abs(x - player.x) + Math.abs(y - player.y);
                
                // Check if move is valid
                if (distance <= this.remainingMoves && !this.isOccupied(x, y)) {
                    player.x = x;
                    player.y = y;
                    this.remainingMoves -= distance;
                    
                    this.addLog(`Player ${this.currentPlayer} moved to (${x}, ${y})`, this.currentPlayer);
                    
                    if (this.remainingMoves <= 0) {
                        this.cancelAction();
                        this.endTurn();
                    } else {
                        this.highlightMoveRange();
                    }
                    
                    this.updateGrid();
                }
            }
            
            heal() {
                const player = this.players[this.currentPlayer];
                const healAmount = 20;
                
                player.hp = Math.min(player.maxHp, player.hp + healAmount);
                this.addLog(`Player ${this.currentPlayer} healed for ${healAmount} HP`, this.currentPlayer);
                
                this.updateDisplay();
                this.endTurn();
            }
            
            cancelAction() {
                this.selectedAction = null;
                this.isAiming = false;
                this.clearHighlights();
                document.getElementById('aimControls').style.display = 'none';
            }
            
            endTurn() {
                this.cancelAction();
                this.currentPlayer = this.currentPlayer === 1 ? 2 : 1;
                this.addLog(`Player ${this.currentPlayer}'s turn`, 'system');
                this.updateDisplay();
                this.updateGrid();
            }
            
            isOccupied(x, y) {
                return Object.values(this.players).some(player => 
                    player.x === x && player.y === y
                );
            }
            
            clearHighlights() {
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    cell.classList.remove('highlighted', 'aim-highlight');
                });
            }
            
            getCell(x, y) {
                return document.querySelector(`.grid-cell[data-x="${x}"][data-y="${y}"]`);
            }
            
            updateGrid() {
                this.initGrid();
            }
            
            updateDisplay() {
                // Update health bars and text
                document.getElementById('hp1').textContent = this.players[1].hp;
                document.getElementById('hp2').textContent = this.players[2].hp;
                document.getElementById('health1').style.width = `${(this.players[1].hp / this.players[1].maxHp) * 100}%`;
                document.getElementById('health2').style.width = `${(this.players[2].hp / this.players[2].maxHp) * 100}%`;
                
                // Update weapon info
                document.querySelectorAll('.current-weapon').forEach((el, index) => {
                    const player = this.players[index + 1];
                    el.textContent = `Weapon: ${player.weapon.name} (Damage: ${player.weapon.minDamage}-${player.weapon.maxDamage}, Range: ${player.weapon.range})`;
                });
                
                // Disable buttons for inactive player
                const isPlayer1Turn = this.currentPlayer === 1;
                document.getElementById('moveBtn').disabled = !isPlayer1Turn;
                document.getElementById('aimBtn').disabled = !isPlayer1Turn;
                document.getElementById('healBtn').disabled = !isPlayer1Turn;
            }
            
            addLog(message, player = 'system') {
                const log = document.getElementById('gameLog');
                const entry = document.createElement('div');
                entry.className = `log-entry ${player === 1 ? 'player1-log' : player === 2 ? 'player2-log' : 'system-log'}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            }
        }
        
        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.game = new Game();
        });
    </script>
</body>
</html>
